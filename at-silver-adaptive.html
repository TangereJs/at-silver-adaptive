<link rel="import" href="../tangere/tangere.html" />

<link rel="import" href="../liquid.js/liquid-import.html">
<script src="lib/adaptivecards.js"></script>

<dom-module id="at-silver-adaptive">
  <template>
    <style>
      :host {
        display: block;
        box-sizing: border-box;
      }

      .ac-image.ac-selectable {
        cursor: pointer;
      }

      a.ac-anchor {
        text-decoration: none;
      }

      a.ac-anchor:link {
        color: #005A9E;
      }

      a.ac-anchor:visited {
        color: #005A9E;
      }

      a.ac-anchor:link:active {
        color: #004D84;
      }

      a.ac-anchor:visited:active {
        color: #004D84;
      }

      .ac-container.ac-selectable {
        padding: 0px;
      }

      .ac-container.ac-selectable:hover {
        background-color: rgba(0, 0, 0, 0.1);
      }

      .ac-container.ac-selectable:active {
        background-color: rgba(0, 0, 0, 0.15);
      }

      .ac-pushButton {
        overflow: hidden;
        text-overflow: ellipsis;
        text-align: center;
        vertical-align: middle;
        cursor: default;
        font-family: "Segoe UI", sans-serif;
        font-size: 14px;
        font-weight: 600;
        padding: 4px 10px 5px 10px;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        height: 31px;
        background-color: white;
        color: #5D60B3;
        border: 2px solid #5D60B3;
      }

      .ac-pushButton:hover {
        background-color: #5D60B3;
        color: white;
      }

      .ac-pushButton:active {
        background-color: #4F5399;
        color: white;
      }

      .ac-pushButton.expanded {
        background-color: #4F5399;
        color: white;
      }

      .ac-input {
        font-family: "Segoe UI", sans-serif;
        font-size: 14px;
        color: black;
        height: 31px;
      }

      .ac-input.ac-textInput {
        resize: none;
      }

      .ac-input.ac-textInput.ac-multiline {
        height: 72px;
      }

      .ac-input.ac-textInput,
      .ac-input.ac-numberInput,
      .ac-input.ac-dateInput,
      .ac-input.ac-timeInput {
        height: 31px;
      }

      .ac-input.ac-textInput,
      .ac-input.ac-numberInput,
      .ac-input.ac-dateInput,
      .ac-input.ac-timeInput,
      .ac-input.ac-multichoiceInput {
        border: 1px solid #DDDDDD;
        padding: 4px 8px 4px 8px;
      }

    </style>

    <div id="rcContainer"></div>

  </template>
</dom-module>
<script>
(function(){
  var templateCache = {};

  Polymer({
    is: "at-silver-adaptive",
    properties: {
      /**
       * object or json representation of adaptive card
       * 
       * @property view
       * @type String | Object
       * @default null
       */
      view: {
        type: Object,
        value: function() {
          return null;
        },
        xtype: 'json',
        xgridcols: "12",
        maxLines: 0,
        mode: 'application/json'
      },

      /**
       * object or json representation of style values that will be used to render adaptive card
       * 
       * @property hostConfig
       * @type String | Object
       * @default {}
       */
      hostConfig: {
        type: Object,
        value: function() {
          return {};
        },
        xtype: 'json',
        xgridcols: "12",
        maxLines: 0,
        mode: 'application/json'
      },

      /**
       * the data object that will be used to render the liquid template
       * 
       * @property data
       * @type Object
       * @default {}
       */
      data: {
        type: Object,
        value: function() {
          return {};
        },
        xtype: 'json',
        xgridcols: "12",
        maxLines: 0,
        mode: 'application/json'
      }
    },

    $meta: [{
      title: "Adaptive Card",
      type: "element",
      xtype: "at-silver-adaptive",
      events: [],
      icon: "now:wrench"
    }],

    observers: [
      '_updateRenderedView(view, hostConfig, data)'
    ],

    ready: function() {
      this._templateCache = templateCache;
    },

    // TODO(ij): confirm that default host config has all available properties set
    _DEFAULT_HOST_CONFIG: {
      spacing: {
        small: 3,
        default: 8,
        medium: 20,
        large: 30,
        extraLarge: 40,
        padding: 10
      },
      separator: {
        lineThickness: 1,
        lineColor: "#EEEEEE"
      },
      supportsInteractivity: true,
      fontFamily: "Segoe UI",
      fontSizes: {
        small: 12,
        default: 14,
        medium: 17,
        large: 21,
        extraLarge: 26
      },
      fontWeights: {
        lighter: 200,
        default: 400,
        bolder: 600
      },
      containerStyles: {
        default: {
          backgroundColor: "#00000000",
          fontColors: {
            default: {
              normal: "#333333",
              subtle: "#EE333333"
            },
            accent: {
              normal: "#2E89FC",
              subtle: "#882E89FC"
            },
            attention: {
              normal: "#FF0000",
              subtle: "#DDFFD800"
            },
            good: {
              normal: "#00FF00",
              subtle: "#DD00FF00"
            },
            warning: {
              normal: "#FFD800",
              subtle: "#DDFF0000"
            }
          }
        },
        emphasis: {
          backgroundColor: "08000000",
          fontColors: {
            default: {
              normal: "#333333",
              subtle: "#EE333333"
            },
            accent: {
              normal: "#2E89FC",
              subtle: "#882E89FC"
            },
            attention: {
              normal: "#FFD800",
              subtle: "#DDFFD800"
            },
            good: {
              normal: "#00FF00",
              subtle: "#DD00FF00"
            },
            warning: {
              normal: "#FF0000",
              subtle: "#DDFF0000"
            }
          }
        }
      },
      imageSizes: {
        small: 40,
        medium: 80,
        large: 160
      },
      actions: {
        maxActions: 3,
        spacing: 2,
        buttonSpacing: 10,
        showCard: {
          actionMode: "inline",
          inlineTopMargin: 16
        },
        actionsOrientation: 0,
        actionAlignment: 0
      },
      adaptiveCard: {
        allowCustomStyle: false
      },
      image: {
        size: "medium",
      },
      imageSet: {
        imageSize: "medium",
        maxImageHeight: 100
      },
      factSet: {
        title: {
          color: "default",
          size: "default",
          isSubtle: false,
          weight: "bolder",
          wrap: true,
          maxWidth: 150
        },
        value: {
          color: "default",
          size: "default",
          isSubtle: false,
          weight: "default",
          wrap: true
        },
        spacing: 10
      }
    },

    // TODO(ij): consider making view a string only; if view is object liquid parsing will be ignored

    _updateRenderedView: function(view, hostConfig, data) {
      function isString(obj) {
        return Object.prototype.toString.apply(obj) === "[object String]";
      }

      if (!view) return;

      if (isString(view)) {
        try {
          var lqView = this._templateCache[view];

          if (!lqView) {
            lqView = Liquid.parse(view);
            this._templateCache[view] = lqView;
          }

          if (isString(data)) {
            data = JSON.parse(data);
          }

          var lqJson = lqView.render(data);
          
          view = JSON.parse(lqJson);

        } catch (e) { 
          // console.log(e);
        }
      }

      var config = this._DEFAULT_HOST_CONFIG;
      
      if (this._isObject(hostConfig)) {
        // merge hostConfig with default config and use that as config
        config = this._mergeConfigurations(this._DEFAULT_HOST_CONFIG, hostConfig);

      } else if (isString(hostConfig)) {
        // parse json and merge with default config and use that as config
        try {
          var hostConfigObj = JSON.parse(hostConfig);
          config = this._mergeConfigurations(this._DEFAULT_HOST_CONFIG, hostConfigObj);
        } catch (e) { console.log(e); }
      }

      var adaptiveCard = new AdaptiveCards.AdaptiveCard();
      adaptiveCard.hostConfig = config;
      adaptiveCard.parse(view);
      var renderedCard = adaptiveCard.render();

      Polymer.dom(this.$.rcContainer).innerHTML = "";
      Polymer.dom(this.$.rcContainer).appendChild(renderedCard);

      // TODO(ij): when actions are performed style scoping is lost
      var child = Polymer.dom(this.$.rcContainer).children[0];
      this.scopeSubtree(child, true);
    },

    _mergeConfigurations: function(src1, src2) {
      var result = {};

      var src1keys = Object.keys(src1);
      var src2keys = Object.keys(src2);

      if (!src2keys.length) return src1;

      // iterate over src1 keys
      src1keys.forEach(function(src1key) {
        // check if src1key exists in src2
        var exists = this._existsInArray(src1key, src2keys);
        
        if (exists) {
          // if exists copy values from src2 to result
          var src1Value = src1[src1key];
          var src2Value = src2[src1key];

          if (this._isObject(src1Value) && this._isObject(src2Value)) {
            result[src1key] = this._mergeConfigurations(src1[src1key], src2[src1key]);

          } else {            
            result[src1key] = src2Value;
          }

        } else {
          // else use values from src1
          result[src1key] = src1[src1key];
        }
      }, this);

      return result;
    },

    _isObject: function(obj) {
      return Object.prototype.toString.apply(obj) === "[object Object]";
    },

    _isArray: function(obj) {
      return Object.prototype.toString.apply(obj) === "[object Array]";
    },

    _existsInArray: function(key, array) {
      for (var i = 0; i < array.length; i++) {
        var current = array[i];
        if (current === key) return true;
      }

      return false;
    }

  });
})();
</script>
